rm(list=ls())
library(R.matlab)
library(oro.nifti)
library(plyr)
library(ggplot2)
library(reshape2)
library(RColorBrewer)
library(knitrBootstrap)
library(xtable)
library(scales)
library(animation)
library(cttools)
writepng = function(fname, tempimg= NULL, adder ='', rerun=TRUE,
text = "", col.y = alpha(hotmetal(10), 0.7), ...){
pngname = gsub("\\.nii\\.gz",
paste0(adder, ".png"), fname)
if (!file.exists(pngname) | rerun){
pimg = readNIfTI(fname)
# mask.overlay
png(pngname, type="cairo")
if (is.null(tempimg)) {
orthographic(pimg, text=text, ...)
} else {
mask.overlay(tempimg, pimg, col.y=col.y, ...)
}
dev.off()
}
return(pngname)
}
img_cut = function(img, breaks, ...){
cuts = cut(img, breaks=breaks, ...)
# cuts = factor(cuts, levels)
levs = levels(cuts)
cuts = as.numeric(cuts)
# res.p[ rs > ncut ] = cuts
img@.Data = array(cuts, dim=dim(img))
return(list(img=img, levs=levs))
}
### need cairo for cluster
options(bitmapType='cairo')
homedir = "/Applications"
rootdir = "/Volumes/DATA_LOCAL/Image_Processing"
if (Sys.info()[["user"]] %in% "jmuschel") {
homedir = "~"
rootdir = "/dexter/disk2/smart/stroke_ct/ident"
}
progdir = file.path(rootdir, "programs")
# source(file.path(progdir, "convert_DICOM.R"))
# source(file.path(progdir, "fslhd.R"))
basedir = file.path(rootdir, "Registration")
#### baseline NIHSSS ata
nihss = read.csv(file.path(basedir, "baseline_NIHSS.csv"),
stringsAsFactors=FALSE)
tempdir = file.path(rootdir, "Template")
atlasdir = file.path(tempdir, "atlases")
outdir = file.path(basedir, "results")
whichdir = "reoriented"
# whichdir = "FLIRT"
rerun = FALSE
template = file.path(tempdir, "scct_unsmooth.nii.gz")
temp = readNIfTI(template)
t.t1 = file.path(tempdir, "sct1_unsmooth.nii.gz")
temp.t1 = readNIfTI(t.t1)
setwd(progdir)
spm.binimg = file.path(outdir, paste0(whichdir, "_Binary_Sum_Image"))
spm.binimg = paste0(spm.binimg, ".nii.gz")
col.y = alpha(div_gradient_pal(low="blue",
mid=muted("red"),
high="yellow")(
seq(0, 1, length=100)
), 1)
fname = spm.binimg
spm2_t1_hot_overlay.png = writepng(spm.binimg, tempimg= temp.t1,
adder = "_t1_heat_overlay", window = c(500, 1000),
col.y = col.y,
rerun=TRUE, text ="Weighted Average")
tempimg = temp.t1
window = c(300, 1000)
text ="Population Average"
pimg = readNIfTI(fname)
